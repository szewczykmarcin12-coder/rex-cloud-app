import React, { useState, useEffect } from 'react';
import { Calendar, Home, Umbrella, Clock, Menu, X, ChevronLeft, ChevronRight, LogOut, Info, User, Plus, Cloud, RefreshCw, Download, Upload } from 'lucide-react';
import ReactDOM from 'react-dom/client';

const API_URL = 'https://rex-cloud-backend.vercel.app/api/calendar';
const DEFAULT_LOCATION = 'Popeyes PLK Krak√≥w Galeria Krakowska';
const positionColors = { 'KIT': '#7CB342', 'CAS': '#00A3E0', 'SUP': '#E74C3C', 'RUN': '#9C27B0' };
const monthNames = ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'];
const dayNames = ['PON', 'WT', '≈öR', 'CZW', 'PT', 'SOB', 'NIEDZ'];

const parseICS = (icsContent) => {
  const shifts = [];
  const dayNamesFull = ['NIEDZ', 'PON', 'WT', '≈öR', 'CZW', 'PT', 'SOB'];
  icsContent.split('BEGIN:VEVENT').slice(1).forEach((block, i) => {
    try {
      const get = (f) => { const m = block.match(new RegExp(f + '[^:]*:(.+?)(?:\\r?\\n|$)')); return m ? m[1].trim() : null; };
      const dtstart = get('DTSTART'), dtend = get('DTEND'), summary = get('SUMMARY'), location = get('LOCATION') || DEFAULT_LOCATION, uid = get('UID');
      if (dtstart && summary) {
        const parseDate = (s) => { if (!s) return null; const c = s.replace('Z', '').replace(/[^0-9T]/g, ''); return new Date(parseInt(c.substring(0,4)), parseInt(c.substring(4,6))-1, parseInt(c.substring(6,8)), parseInt(c.substring(9,11))||0, parseInt(c.substring(11,13))||0); };
        const start = parseDate(dtstart), end = parseDate(dtend);
        if (start) {
          const posMatch = summary.match(/^(KIT|CAS|SUP|RUN)/i);
          const pos = posMatch ? posMatch[1].toUpperCase() : 'KIT';
          shifts.push({ id: uid || 'shift-'+Date.now()+'-'+i, date: start.getFullYear()+'-'+String(start.getMonth()+1).padStart(2,'0')+'-'+String(start.getDate()).padStart(2,'0'), dayName: dayNamesFull[start.getDay()], dayNum: start.getDate(), shifts: [{ time: String(start.getHours()).padStart(2,'0')+':'+String(start.getMinutes()).padStart(2,'0')+' - '+(end ? String(end.getHours()).padStart(2,'0')+':'+String(end.getMinutes()).padStart(2,'0') : '23:00'), type: pos, color: positionColors[pos] || '#00A3E0' }], location: location.replace(/\\n/g, ' ') });
        }
      }
    } catch(e) {}
  });
  return shifts.sort((a,b) => new Date(a.date) - new Date(b.date));
};

const generateICS = (shifts) => {
  const fmt = (d) => d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0')+'00';
  const events = shifts.map(s => { const [st, et] = s.shifts[0].time.split(' - '); const [sh, sm] = st.split(':'); const [eh, em] = et.split(':'); const start = new Date(s.date); start.setHours(+sh, +sm); const end = new Date(s.date); end.setHours(+eh, +em); const uid = typeof s.id === 'string' && s.id.includes('@') ? s.id : 'shift-'+s.id+'@rexcloud.app'; return 'BEGIN:VEVENT\nUID:'+uid+'\nDTSTAMP:'+fmt(new Date())+'\nDTSTART:'+fmt(start)+'\nDTEND:'+fmt(end)+'\nSUMMARY:'+s.shifts[0].type+' - Popeyes PLK\nLOCATION:'+s.location+'\nSTATUS:CONFIRMED\nEND:VEVENT'; }).join('\n');
  return 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//REX Cloud//PL\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\nX-WR-CALNAME:REX Cloud\n'+events+'\nEND:VCALENDAR';
};

const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState(''); const [pin, setPin] = useState(''); const [error, setError] = useState('');
  const handleLogin = () => { if (email === 'szewczyk.marcin12@gmail.com' && pin === '4917') onLogin(); else setError(email && pin ? 'Nieprawid≈Çowe dane' : 'Wprowad≈∫ dane'); };
  return (<div className="min-h-screen bg-gradient-to-b from-slate-800 to-slate-900 flex items-center justify-center p-6"><div className="w-full max-w-sm"><div className="flex items-center justify-center gap-3 mb-12"><div className="w-14 h-14 bg-cyan-500 rounded-xl flex items-center justify-center"><Cloud size={32} className="text-white" /></div><div><span className="text-white text-3xl font-light">REX</span><span className="text-cyan-300 text-3xl font-light ml-2">Cloud</span></div></div><div className="bg-white rounded-2xl p-8"><h2 className="text-2xl font-semibold text-center mb-6">Zaloguj siƒô</h2>{error && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm">{error}</div>}<div className="space-y-4"><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-xl border" placeholder="Email" /><input type="password" value={pin} onChange={(e) => setPin(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-3 rounded-xl border" placeholder="PIN" maxLength={4} /><button onClick={handleLogin} className="w-full bg-cyan-500 text-white font-semibold py-3 rounded-xl">Zaloguj siƒô</button></div></div></div></div>);
};

const CalendarView = ({ date, onDateChange, shifts, onDayClick, selectedDay }) => {
  const year = date.getFullYear(), month = date.getMonth();
  const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0), startDay = (firstDay.getDay() + 6) % 7;
  const days = []; for (let i = 0; i < startDay; i++) days.push({ day: new Date(year, month, 0).getDate() - startDay + i + 1, current: false }); for (let i = 1; i <= lastDay.getDate(); i++) days.push({ day: i, current: true }); for (let i = 1; days.length < 42; i++) days.push({ day: i, current: false });
  const getShifts = (d) => { const ds = year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'); return shifts.find(s => s.date === ds)?.shifts || []; };
  const today = new Date(), isToday = (d) => today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
  return (<div className="bg-white"><div className="flex items-center justify-between px-4 py-4 border-b"><button onClick={() => onDateChange(new Date(year, month-1, 1))} className="p-2"><ChevronLeft size={24} /></button><span className="text-lg font-semibold">{monthNames[month]} {year}</span><button onClick={() => onDateChange(new Date(year, month+1, 1))} className="p-2"><ChevronRight size={24} /></button></div><div className="grid grid-cols-7 gap-1 p-2">{dayNames.map(d => <div key={d} className="text-center text-xs font-medium text-slate-500 py-2">{d}</div>)}{days.map((item, i) => { const sh = item.current ? getShifts(item.day) : []; return (<button key={i} onClick={() => item.current && onDayClick(item.day === selectedDay ? null : item.day)} className={`flex flex-col items-center py-2 rounded-full ${!item.current ? 'text-slate-300' : selectedDay === item.day ? 'bg-cyan-100 text-cyan-700' : isToday(item.day) ? 'bg-cyan-500 text-white' : 'text-slate-700'}`}><span className="text-sm font-medium">{item.day}</span>{sh.length > 0 && item.current && <div className="flex gap-0.5 mt-1">{sh.slice(0,3).map((s,j) => <div key={j} className="w-1.5 h-1.5 rounded-full" style={{backgroundColor: s.color}} />)}</div>}</button>); })}</div></div>);
};

const Sidebar = ({ isOpen, onClose, currentPage, onNavigate, user, onLogout }) => {
  const items = [{ id: 'home', icon: Home, label: 'Strona domowa' }, { id: 'shifts', icon: Calendar, label: 'Zmiany' }, { id: 'holidays', icon: Umbrella, label: 'Czas wolny' }, { id: 'workedTime', icon: Clock, label: 'Przepracowany Czas' }, { id: 'userData', icon: User, label: 'Dane u≈ºytkownika' }, { id: 'about', icon: Info, label: 'O Aplikacji' }];
  return (<>{isOpen && <div className="fixed inset-0 bg-black/50 z-40" onClick={onClose} />}<div className={`fixed top-0 left-0 h-full w-72 bg-white z-50 transform transition-transform flex flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}><div className="bg-gradient-to-r from-cyan-500 to-cyan-600 p-4 pt-8"><div className="flex items-center gap-2 mb-4"><Cloud size={24} className="text-white" /><span className="text-white text-lg font-light">REX <span className="text-cyan-200">Cloud</span></span></div></div><div className="p-4 border-b flex items-center gap-3"><div className="w-12 h-12 bg-cyan-500 rounded-full flex items-center justify-center text-white font-semibold">{user.initials}</div><div><p className="font-semibold text-sm">{user.name}</p><p className="text-slate-500 text-xs">{user.email}</p></div></div><nav className="p-4 flex-1">{items.map(item => (<button key={item.id} onClick={() => { onNavigate(item.id); onClose(); }} className={`w-full flex items-center gap-4 px-4 py-3 rounded-xl ${currentPage === item.id ? 'bg-cyan-50 text-cyan-600' : 'text-slate-600'}`}><item.icon size={20} /><span className="font-medium">{item.label}</span></button>))}</nav><div className="p-4 border-t"><button onClick={() => { onLogout(); onClose(); }} className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-red-600"><LogOut size={20} /><span className="font-medium">Wyloguj siƒô</span></button></div></div></>);
};

const Header = ({ title, onMenuClick }) => (<div className="bg-gradient-to-r from-cyan-500 to-cyan-600 text-white px-4 py-4 flex items-center justify-between sticky top-0 z-30"><div className="flex items-center gap-3"><Cloud size={24} /><span className="text-lg font-medium">{title}</span></div><button onClick={onMenuClick} className="p-2"><Menu size={24} /></button></div>);

const HomePage = ({ nextShift, onNavigateToShifts, vacation, onNavigateToHolidays }) => {
  const calcCountdown = (dateStr, time) => { if (!dateStr) return { days: 0, hours: 0, min: 0 }; const target = new Date(dateStr); if (time) { const [h, m] = time.split(':'); target.setHours(+h, +m); } const diff = target - new Date(); if (diff <= 0) return { days: 0, hours: 0, min: 0 }; return { days: Math.floor(diff / 86400000), hours: Math.floor((diff % 86400000) / 3600000), min: Math.floor((diff % 3600000) / 60000) }; };
  const shiftCountdown = nextShift ? calcCountdown(nextShift.date, nextShift.shifts[0].time.split(' - ')[0]) : null;
  const vacCountdown = vacation ? calcCountdown(vacation.startDate) : { days: 0, hours: 0, min: 0 };
  const vacDate = vacation ? new Date(vacation.startDate) : null;
  const vacEndDate = vacation ? new Date(vacation.endDate) : null;
  const vacDayNames = ['NIEDZ', 'PON', 'WT', '≈öR', 'CZW', 'PT', 'SOB'];
  const formatDate = (d) => d.getDate()+'.'+String(d.getMonth()+1).padStart(2,'0');
  return (<div className="p-4 space-y-4 pb-24"><div className="bg-white rounded-2xl shadow-sm border-l-4 border-cyan-500 p-4 cursor-pointer" onClick={onNavigateToShifts}><div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold">Nastƒôpna zmiana</h3><Calendar size={24} className="text-cyan-500" /></div>{nextShift ? (<div className="flex gap-4"><div className="bg-slate-50 rounded-xl p-3 text-center min-w-16"><p className="text-sm text-slate-500">{nextShift.dayName}</p><p className="text-3xl font-bold">{nextShift.dayNum}</p><p className="text-sm text-slate-500">{monthNames[new Date(nextShift.date).getMonth()].substring(0,3).toUpperCase()}</p></div><div className="flex-1">{nextShift.shifts.map((s, i) => (<div key={i} className="flex items-center gap-2 mb-1"><Clock size={16} className="text-slate-400" /><span>{s.time}</span><span className="text-sm px-2 py-0.5 rounded" style={{backgroundColor: s.color+'20', color: s.color}}>{s.type}</span></div>))}<p className="text-slate-500 text-sm mt-1">{nextShift.location}</p><div className="flex gap-4 mt-4 pt-3 border-t"><div className="text-center"><p className="text-2xl font-bold text-cyan-500">{shiftCountdown.days}</p><p className="text-xs text-slate-500">Dni</p></div><div className="text-center"><p className="text-2xl font-bold">{shiftCountdown.hours}</p><p className="text-xs text-slate-500">godz</p></div><div className="text-center"><p className="text-2xl font-bold">{shiftCountdown.min}</p><p className="text-xs text-slate-500">min</p></div></div></div></div>) : (<div className="text-center py-4"><Cloud size={40} className="text-slate-200 mx-auto mb-2" /><p className="text-slate-500">Brak zaplanowanych zmian</p></div>)}</div><div className="bg-white rounded-2xl shadow-sm border-l-4 border-amber-400 p-4 cursor-pointer" onClick={onNavigateToHolidays}><div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold">Nastƒôpny urlop</h3><Umbrella size={24} className="text-amber-500" /></div>{vacation ? (<div className="flex gap-4"><div className="bg-amber-50 rounded-xl p-3 text-center min-w-16"><p className="text-sm text-amber-600">{vacDayNames[vacDate.getDay()]}</p><p className="text-3xl font-bold">{vacDate.getDate()}</p><p className="text-sm text-amber-600">{monthNames[vacDate.getMonth()].substring(0,3).toUpperCase()}</p></div><div className="flex-1"><div className="flex items-center gap-2 mb-1"><Umbrella size={16} className="text-amber-500" /><span className="font-medium">{vacation.type}</span></div><div className="flex items-center gap-2 text-slate-600 text-sm"><Calendar size={14} className="text-slate-400" /><span>{formatDate(vacDate)} - {formatDate(vacEndDate)}</span></div><p className="text-amber-600 text-sm font-medium mt-1">≈ÅƒÖcznie: {vacation.totalDays} dni</p><div className="flex gap-4 mt-4 pt-3 border-t"><div className="text-center"><p className="text-2xl font-bold text-amber-500">{vacCountdown.days}</p><p className="text-xs text-slate-500">Dni</p></div><div className="text-center"><p className="text-2xl font-bold">{vacCountdown.hours}</p><p className="text-xs text-slate-500">godz</p></div><div className="text-center"><p className="text-2xl font-bold">{vacCountdown.min}</p><p className="text-xs text-slate-500">min</p></div></div></div></div>) : (<div className="text-center py-4"><Umbrella size={40} className="text-amber-200 mx-auto mb-2" /><p className="text-slate-500">Brak zaplanowanych urlop√≥w</p></div>)}</div></div>);
};

const ShiftsPage = ({ date, onDateChange, shifts, onSync, onSave, syncStatus, saveStatus, lastSync, hasChanges }) => {
  const [selectedDay, setSelectedDay] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const filtered = shifts.filter(s => { const d = new Date(s.date); return (!selectedDay || d.getDate() === selectedDay) && d.getMonth() === date.getMonth() && d.getFullYear() === date.getFullYear(); });
  const downloadICS = () => { const blob = new Blob([generateICS(shifts)], { type: 'text/calendar' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kalendarz.ics'; a.click(); };
  return (<div className="flex flex-col min-h-screen bg-slate-50 pb-20"><CalendarView date={date} onDateChange={onDateChange} shifts={shifts} onDayClick={setSelectedDay} selectedDay={selectedDay} /><div className="px-4 py-3 bg-white border-b space-y-2"><div className="flex gap-2"><button onClick={onSync} disabled={syncStatus==='syncing'} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-white font-medium ${syncStatus==='error' ? 'bg-red-500' : syncStatus==='success' ? 'bg-green-500' : 'bg-cyan-500'}`}><RefreshCw size={18} className={syncStatus==='syncing' ? 'animate-spin' : ''} /><span>{syncStatus==='syncing' ? 'Pobieranie...' : syncStatus==='error' ? 'B≈ÇƒÖd!' : syncStatus==='success' ? 'Pobrano!' : 'Pobierz z GitHub'}</span></button><button onClick={onSave} disabled={saveStatus==='saving' || !hasChanges} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-white font-medium ${saveStatus==='error' ? 'bg-red-500' : saveStatus==='success' ? 'bg-green-500' : !hasChanges ? 'bg-slate-300' : 'bg-emerald-500'}`}><Upload size={18} className={saveStatus==='saving' ? 'animate-spin' : ''} /><span>{saveStatus==='saving' ? 'Zapisywanie...' : saveStatus==='error' ? 'B≈ÇƒÖd!' : saveStatus==='success' ? 'Zapisano!' : 'Zapisz do GitHub'}</span></button></div>{hasChanges && <p className="text-amber-600 text-xs text-center">‚ö†Ô∏è Masz niezapisane zmiany</p>}<button onClick={() => setShowModal(true)} className="w-full py-2 text-cyan-600 text-sm font-medium">‚ÑπÔ∏è Informacje o synchronizacji</button>{lastSync && <p className="text-xs text-slate-500 text-center">Ostatnia synchronizacja: {lastSync}</p>}</div><div className="flex-1 p-4 space-y-3">{filtered.length === 0 ? (<div className="text-center py-12"><Cloud size={48} className="text-slate-300 mx-auto mb-4" /><p className="text-slate-500">Brak zmian w tym okresie</p></div>) : filtered.map(shift => (<div key={shift.id} className="bg-white rounded-xl shadow-sm border-l-4 border-cyan-400 p-4"><div className="flex gap-4"><div className="bg-cyan-50 rounded-xl px-3 py-2 text-center min-w-14"><p className="text-xs text-cyan-600">{shift.dayName}</p><p className="text-xl font-bold">{shift.dayNum}.{String(new Date(shift.date).getMonth()+1).padStart(2,'0')}</p></div><div className="flex-1">{shift.shifts.map((s,i) => (<div key={i} className="flex items-center gap-2 mb-1"><span>{s.time}</span><span className="w-2 h-2 rounded-full" style={{backgroundColor: s.color}} /><span className="text-sm text-slate-600">{s.type}</span></div>))}<p className="text-slate-500 text-sm mt-1">{shift.location}</p></div></div></div>))}</div>{showModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-md rounded-2xl p-6"><div className="flex items-center justify-between mb-4"><h3 className="text-xl font-semibold">Synchronizacja</h3><button onClick={() => setShowModal(false)} className="p-2"><X size={20} /></button></div><div className="space-y-4"><div className="bg-cyan-50 p-4 rounded-xl"><p className="font-medium text-cyan-800 mb-2">üîÑ Jak dzia≈Ça?</p><p className="text-sm text-cyan-700">Pobierz z GitHub - pobiera zmiany</p><p className="text-sm text-cyan-700">Zapisz do GitHub - zapisuje zmiany</p></div><button onClick={downloadICS} className="w-full py-3 bg-slate-800 text-white rounded-xl flex items-center justify-center gap-2"><Download size={18} /> Pobierz plik .ics</button><button onClick={() => setShowModal(false)} className="w-full py-3 bg-slate-100 rounded-xl">Zamknij</button></div></div></div>)}</div>);
};

const PreferencesPage = ({ date, onDateChange, onAddShift }) => {
  const [prefs, setPrefs] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [newPref, setNewPref] = useState({ date: new Date().toISOString().split('T')[0], type: 'Pracuj', position: 'KIT', timeFrom: '08:00', timeTo: '16:00' });
  const types = ['Pracuj', 'Nie pracuj', 'Nie pracuj wcze≈õniej', 'Nie pracuj p√≥≈∫niej ni≈º', 'Praca w godzinach'];
  const positions = [{ id: 'KIT', name: 'KIT - Kuchnia' }, { id: 'CAS', name: 'CAS - Kasa' }, { id: 'SUP', name: 'SUP - Wsparcie' }, { id: 'RUN', name: 'RUN - Runner' }];
  const needsFrom = ['Nie pracuj wcze≈õniej', 'Praca w godzinach'].includes(newPref.type);
  const needsTo = ['Nie pracuj p√≥≈∫niej ni≈º', 'Praca w godzinach'].includes(newPref.type);
  const needsPos = newPref.type !== 'Nie pracuj';
  const handleAdd = () => { const d = new Date(newPref.date); const dayNames = ['NI', 'PO', 'WT', '≈öR', 'CZ', 'PT', 'SO']; const dayNamesFull = ['NIEDZ', 'PON', 'WT', '≈öR', 'CZW', 'PT', 'SOB']; const pref = { id: Date.now(), date: newPref.date, dayName: dayNames[d.getDay()], dayNum: d.getDate(), type: newPref.type, position: needsPos ? newPref.position : null, timeFrom: needsFrom ? newPref.timeFrom : null, timeTo: needsTo ? newPref.timeTo : null }; setPrefs([...prefs, pref]); if (newPref.type !== 'Nie pracuj') { const time = newPref.type === 'Praca w godzinach' ? newPref.timeFrom+' - '+newPref.timeTo : newPref.type === 'Nie pracuj wcze≈õniej' ? newPref.timeFrom+' - 23:00' : newPref.type === 'Nie pracuj p√≥≈∫niej ni≈º' ? '06:00 - '+newPref.timeTo : '08:00 - 16:00'; onAddShift({ id: Date.now()+1, date: newPref.date, dayName: dayNamesFull[d.getDay()], dayNum: d.getDate(), shifts: [{ time, type: newPref.position, color: positionColors[newPref.position] }], location: DEFAULT_LOCATION }); } setShowModal(false); setNewPref({ date: new Date().toISOString().split('T')[0], type: 'Pracuj', position: 'KIT', timeFrom: '08:00', timeTo: '16:00' }); };
  return (<div className="flex flex-col min-h-screen bg-slate-50 pb-20"><div className="bg-white px-4 py-4 border-b flex items-center justify-between"><button onClick={() => onDateChange(new Date(date.getFullYear(), date.getMonth()-1, 1))} className="p-2"><ChevronLeft size={24} /></button><span className="font-semibold">{monthNames[date.getMonth()]} {date.getFullYear()}</span><button onClick={() => onDateChange(new Date(date.getFullYear(), date.getMonth()+1, 1))} className="p-2"><ChevronRight size={24} /></button></div><div className="p-4"><button onClick={() => setShowModal(true)} className="flex items-center gap-2 text-cyan-600 font-medium mb-4"><Plus size={20} /><span className="underline">Nowy wniosek o zmianƒô</span></button>{prefs.length === 0 ? (<div className="text-center py-12"><Cloud size={48} className="text-slate-300 mx-auto mb-4" /><p className="text-slate-500">Brak wniosk√≥w</p></div>) : prefs.map(p => (<div key={p.id} className="bg-white rounded-xl shadow-sm border-l-4 border-cyan-400 p-4 mb-3"><div className="flex items-center gap-4"><div className="bg-cyan-50 rounded-xl px-3 py-2 text-center min-w-14"><p className="text-xs text-cyan-600">{p.dayName}</p><p className="text-xl font-bold">{p.dayNum}</p></div><div><p className="font-medium">{p.type}</p>{p.position && <p className="text-sm text-slate-600">{p.position}</p>}{(p.timeFrom || p.timeTo) && <p className="text-sm text-slate-500">{p.timeFrom && 'od '+p.timeFrom} {p.timeTo && 'do '+p.timeTo}</p>}</div></div></div>))}</div>{showModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center"><div className="bg-white w-full max-w-lg rounded-t-3xl p-6"><h3 className="text-xl font-semibold mb-6">Nowy wniosek o zmianƒô</h3><div className="space-y-4"><div><label className="block text-sm font-medium text-cyan-600 mb-2">Data</label><input type="date" value={newPref.date} onChange={(e) => setNewPref({...newPref, date: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" /></div><div><label className="block text-sm font-medium text-cyan-600 mb-2">Rodzaj</label><select value={newPref.type} onChange={(e) => setNewPref({...newPref, type: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl">{types.map(t => <option key={t} value={t}>{t}</option>)}</select></div>{needsFrom && (<div><label className="block text-sm font-medium text-cyan-600 mb-2">Od godziny</label><input type="time" value={newPref.timeFrom} onChange={(e) => setNewPref({...newPref, timeFrom: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" /></div>)}{needsTo && (<div><label className="block text-sm font-medium text-cyan-600 mb-2">Do godziny</label><input type="time" value={newPref.timeTo} onChange={(e) => setNewPref({...newPref, timeTo: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" /></div>)}{needsPos && (<div><label className="block text-sm font-medium text-cyan-600 mb-2">Pozycja</label><select value={newPref.position} onChange={(e) => setNewPref({...newPref, position: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl">{positions.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>)}<div className="bg-green-50 p-3 rounded-xl text-sm text-green-700">‚úì Zmiana zostanie dodana. Pamiƒôtaj o klikniƒôciu "Zapisz do GitHub"!</div></div><div className="flex gap-3 mt-6"><button onClick={() => setShowModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-semibold">Anuluj</button><button onClick={handleAdd} className="flex-1 py-3 bg-cyan-500 text-white rounded-xl font-semibold">Dodaj zmianƒô</button></div></div></div>)}</div>);
};

const HolidaysPage = ({ vacation, onAddVacation }) => {
  const [showModal, setShowModal] = useState(false);
  const [newVac, setNewVac] = useState({ startDate: '', endDate: '', type: 'Urlop wypoczynkowy' });
  const vacTypes = ['Urlop wypoczynkowy', 'Urlop na ≈ºƒÖdanie', 'Urlop bezp≈Çatny', 'Zwolnienie lekarskie', 'Inny'];
  const vacDayNames = ['NIEDZ', 'PON', 'WT', '≈öR', 'CZW', 'PT', 'SOB'];
  const calcCountdown = (dateStr) => { if (!dateStr) return { days: 0, hours: 0, min: 0 }; const diff = new Date(dateStr) - new Date(); if (diff <= 0) return { days: 0, hours: 0, min: 0 }; return { days: Math.floor(diff / 86400000), hours: Math.floor((diff % 86400000) / 3600000), min: Math.floor((diff % 3600000) / 60000) }; };
  const formatDate = (d) => d.getDate()+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+d.getFullYear();
  const handleAdd = () => { if (newVac.startDate && newVac.endDate) { const start = new Date(newVac.startDate); const end = new Date(newVac.endDate); const days = Math.ceil((end - start) / 86400000) + 1; onAddVacation({ startDate: newVac.startDate, endDate: newVac.endDate, type: newVac.type, totalDays: days }); setShowModal(false); setNewVac({ startDate: '', endDate: '', type: 'Urlop wypoczynkowy' }); } };
  const vacDate = vacation ? new Date(vacation.startDate) : null;
  const vacEndDate = vacation ? new Date(vacation.endDate) : null;
  const vacCountdown = vacation ? calcCountdown(vacation.startDate) : null;
  return (<div className="flex flex-col min-h-screen bg-slate-50 pb-24"><div className="p-4"><button onClick={() => setShowModal(true)} className="flex items-center gap-2 text-amber-600 font-medium mb-4"><Plus size={20} /><span className="underline">Dodaj nowy urlop</span></button>{vacation ? (<div className="bg-white rounded-2xl shadow-sm border-l-4 border-amber-400 p-4"><div className="flex items-center justify-between mb-4"><h3 className="text-lg font-semibold">Zaplanowany urlop</h3><Umbrella size={24} className="text-amber-500" /></div><div className="flex gap-4"><div className="bg-amber-50 rounded-xl p-3 text-center min-w-16"><p className="text-sm text-amber-600">{vacDayNames[vacDate.getDay()]}</p><p className="text-3xl font-bold">{vacDate.getDate()}</p><p className="text-sm text-amber-600">{monthNames[vacDate.getMonth()].substring(0,3).toUpperCase()}</p></div><div className="flex-1"><div className="flex items-center gap-2 mb-1"><Umbrella size={16} className="text-amber-500" /><span className="font-medium">{vacation.type}</span></div><div className="flex items-center gap-2 text-slate-600 text-sm"><Calendar size={14} className="text-slate-400" /><span>{formatDate(vacDate)} - {formatDate(vacEndDate)}</span></div><p className="text-amber-600 text-sm font-medium mt-1">≈ÅƒÖcznie: {vacation.totalDays} dni</p><div className="flex gap-4 mt-4 pt-3 border-t"><div className="text-center"><p className="text-2xl font-bold text-amber-500">{vacCountdown.days}</p><p className="text-xs text-slate-500">Dni</p></div><div className="text-center"><p className="text-2xl font-bold">{vacCountdown.hours}</p><p className="text-xs text-slate-500">godz</p></div><div className="text-center"><p className="text-2xl font-bold">{vacCountdown.min}</p><p className="text-xs text-slate-500">min</p></div></div></div></div></div>) : (<div className="bg-white rounded-2xl shadow-sm p-8 text-center"><Umbrella size={64} className="text-amber-200 mx-auto mb-4" /><p className="text-slate-500 mb-4">Brak zaplanowanych urlop√≥w</p><button onClick={() => setShowModal(true)} className="px-6 py-3 bg-amber-500 text-white font-semibold rounded-xl">Z≈Ç√≥≈º wniosek</button></div>)}</div>{showModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center"><div className="bg-white w-full max-w-lg rounded-t-3xl p-6"><h3 className="text-xl font-semibold mb-6">Nowy wniosek urlopowy</h3><div className="space-y-4"><div><label className="block text-sm font-medium text-amber-600 mb-2">Typ urlopu</label><select value={newVac.type} onChange={(e) => setNewVac({...newVac, type: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl">{vacTypes.map(t => <option key={t} value={t}>{t}</option>)}</select></div><div><label className="block text-sm font-medium text-amber-600 mb-2">Data rozpoczƒôcia</label><input type="date" value={newVac.startDate} onChange={(e) => setNewVac({...newVac, startDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" /></div><div><label className="block text-sm font-medium text-amber-600 mb-2">Data zako≈Ñczenia</label><input type="date" value={newVac.endDate} onChange={(e) => setNewVac({...newVac, endDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" /></div>{newVac.startDate && newVac.endDate && (<div className="bg-amber-50 p-3 rounded-xl text-sm text-amber-700">≈ÅƒÖczna liczba dni: <strong>{Math.ceil((new Date(newVac.endDate) - new Date(newVac.startDate)) / 86400000) + 1}</strong></div>)}</div><div className="flex gap-3 mt-6"><button onClick={() => setShowModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-semibold">Anuluj</button><button onClick={handleAdd} className="flex-1 py-3 bg-amber-500 text-white rounded-xl font-semibold">Z≈Ç√≥≈º wniosek</button></div></div></div>)}</div>);
};

const WorkedTimePage = () => (<div className="flex flex-col min-h-screen bg-slate-50 items-center justify-center p-8 pb-24"><Clock size={64} className="text-slate-300 mb-6" /><h2 className="text-xl font-semibold mb-2">Przepracowany czas</h2><p className="text-slate-500 text-center">Brak danych</p></div>);

const UserDataPage = ({ user, onUpdate }) => {
  const [form, setForm] = useState(user);
  const [saved, setSaved] = useState(false);
  const save = () => { onUpdate(form); setSaved(true); setTimeout(() => setSaved(false), 2000); };
  return (<div className="min-h-screen bg-slate-50 p-4 pb-24"><div className="bg-white rounded-2xl overflow-hidden"><div className="bg-gradient-to-r from-cyan-500 to-cyan-600 p-6 text-center"><div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-3"><span className="text-cyan-600 font-bold text-2xl">{user.initials}</span></div><h2 className="text-white text-xl font-semibold">{form.name}</h2></div><div className="p-4 space-y-4"><input value={form.name} onChange={(e) => setForm({...form, name: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" placeholder="Imiƒô i nazwisko" /><input value={form.email} disabled className="w-full p-3 bg-slate-100 rounded-xl text-slate-500" /><input value={form.phone} onChange={(e) => setForm({...form, phone: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" placeholder="Telefon" /><input value={form.address} onChange={(e) => setForm({...form, address: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl" placeholder="Adres" /><button onClick={save} className={`w-full py-3 rounded-xl font-semibold ${saved ? 'bg-green-500 text-white' : 'bg-cyan-500 text-white'}`}>{saved ? '‚úì Zapisano' : 'Zapisz zmiany'}</button></div></div></div>);
};

const AboutPage = () => (<div className="min-h-screen bg-slate-50 p-4 pb-24"><div className="bg-white rounded-2xl overflow-hidden"><div className="bg-gradient-to-r from-cyan-500 to-cyan-600 p-8 text-center"><Cloud size={40} className="text-white mx-auto mb-4" /><span className="text-white text-2xl font-light">REX <span className="text-cyan-200">Cloud</span></span><p className="text-cyan-100 mt-2">v2.0.0 - GitHub Sync</p></div><div className="p-6 text-center"><p className="text-slate-600 mb-4">Aplikacja do zarzƒÖdzania grafikiem pracy z synchronizacjƒÖ GitHub.</p><p className="text-slate-500 text-sm">¬© 2025 REX Cloud by M. Szewczyk</p></div></div></div>);

export default function REXCloudApp() {
  const [logged, setLogged] = useState(false);
  const [sidebar, setSidebar] = useState(false);
  const [page, setPage] = useState('home');
  const [date, setDate] = useState(new Date(2025, 11, 1));
  const [user, setUser] = useState({ name: 'MARCIN SZEWCZYK', initials: 'MS', email: 'szewczyk.marcin12@gmail.com', company: 'Rex Concepts', phone: '+48 123 456 789', address: 'Krak√≥w' });
  const [shifts, setShifts] = useState([]);
  const [vacation, setVacation] = useState(null);
  const [syncStatus, setSyncStatus] = useState('idle');
  const [saveStatus, setSaveStatus] = useState('idle');
  const [lastSync, setLastSync] = useState(null);
  const [calendarSha, setCalendarSha] = useState(null);
  const [hasChanges, setHasChanges] = useState(false);
  
  useEffect(() => { if (logged) syncFromGitHub(); }, [logged]);
  
  const syncFromGitHub = async () => {
    setSyncStatus('syncing');
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      if (data.success && data.content) {
        const parsed = parseICS(data.content);
        setShifts(parsed);
        setCalendarSha(data.sha);
        setSyncStatus('success');
        setLastSync(new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }));
        setHasChanges(false);
      } else { throw new Error(data.error || 'Error'); }
    } catch (e) { console.error('Sync error:', e); setSyncStatus('error'); }
    setTimeout(() => setSyncStatus('idle'), 2000);
  };
  
  const saveToGitHub = async () => {
    if (!hasChanges) return;
    setSaveStatus('saving');
    try {
      const icsContent = generateICS(shifts);
      const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: icsContent, sha: calendarSha, message: 'Update from REX Cloud' }) });
      const data = await res.json();
      if (data.success) { setCalendarSha(data.sha); setSaveStatus('success'); setHasChanges(false); } else { throw new Error(data.error || 'Error'); }
    } catch (e) { console.error('Save error:', e); setSaveStatus('error'); }
    setTimeout(() => setSaveStatus('idle'), 2000);
  };
  
  const handleLogout = () => { setLogged(false); setPage('home'); setShifts([]); setVacation(null); setLastSync(null); setCalendarSha(null); setHasChanges(false); };
  const addShift = (s) => { setShifts(prev => [...prev.filter(x => x.date !== s.date), s]); setHasChanges(true); };
  const addVacation = (v) => setVacation(v);
  const nextShift = shifts.filter(s => new Date(s.date) >= new Date()).sort((a,b) => new Date(a.date) - new Date(b.date))[0] || null;
  const titles = { home: 'Strona domowa', shifts: 'Zmiany', preferences: 'Wniosek o zmiany', holidays: 'Czas wolny', workedTime: 'Przepracowany Czas', userData: 'Dane u≈ºytkownika', about: 'O Aplikacji' };
  
  if (!logged) return <LoginScreen onLogin={() => setLogged(true)} />;
  
  return (<div className="min-h-screen bg-slate-50"><style>{'.animate-spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }'}</style><Sidebar isOpen={sidebar} onClose={() => setSidebar(false)} currentPage={page} onNavigate={setPage} user={user} onLogout={handleLogout} /><Header title={titles[page] || 'REX Cloud'} onMenuClick={() => setSidebar(true)} />{page === 'home' && <HomePage nextShift={nextShift} onNavigateToShifts={() => setPage('shifts')} vacation={vacation} onNavigateToHolidays={() => setPage('holidays')} />}{page === 'shifts' && <ShiftsPage date={date} onDateChange={setDate} shifts={shifts} onSync={syncFromGitHub} onSave={saveToGitHub} syncStatus={syncStatus} saveStatus={saveStatus} lastSync={lastSync} hasChanges={hasChanges} />}{page === 'preferences' && <PreferencesPage date={date} onDateChange={setDate} onAddShift={addShift} />}{page === 'holidays' && <HolidaysPage vacation={vacation} onAddVacation={addVacation} />}{page === 'workedTime' && <WorkedTimePage />}{page === 'userData' && <UserDataPage user={user} onUpdate={setUser} />}{page === 'about' && <AboutPage />}<div className="fixed bottom-0 left-0 right-0 bg-white border-t px-4 py-2 flex justify-around z-10">{[['home', Home, 'Home'], ['shifts', Calendar, 'Zmiany'], ['preferences', Plus, 'Wnioski'], ['holidays', Umbrella, 'Urlopy']].map(([id, Icon, label]) => (<button key={id} onClick={() => setPage(id)} className={`flex flex-col items-center p-2 ${page === id ? 'text-cyan-500' : 'text-slate-400'}`}><Icon size={24} /><span className="text-xs mt-1">{label}</span></button>))}</div></div>);
}
ReactDOM.createRoot(document.getElementById('root')).render(<REXCloudApp />);
